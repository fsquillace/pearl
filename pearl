#!/bin/bash
# pearl by Filippo Squillace
# (great update 16-12-2009 date of my last exam in UNICAL :)
# (update 21-07-2010 one of my last days in Valencia ยง:(  )
# (update 07-01-2012 ending the thesis in Valencia)
# (update 29-01-2012 continue ending thesis in Valencia)
# (update 27-01-2013 working in Dublin)
# (update 06-02-2013 still in Dublin and big day changing the name in pearl!)
# (update 31-12-2013 modularized the pearl script in Milan!)
# (update 08-09-2014 making pearl even more modularized in Dublin :)
# Usage: source pearl OR bash --rcfile pearl

# If not running interactively, don't do anything
[ -z "$PS1" ] && return
[[ $- != *i* ]] && return


if [ "${BASH_ARGV}" = "" ]; then
    echo "Error the correct usage is: source $0 OR bash --rcfile $0"
    exit 128
fi


# make less more friendly for non-text input files, see lesspipe(1)
[ -x /usr/bin/lesspipe ] && eval "$(SHELL=/bin/sh lesspipe)"

# Possible choices:
#umask   file mode   directory mode
#0022    -rw-r--r--  drwxr-xr-x
#0077    -rw-------  drwx------
umask 0022


# Define the MAIN PEARL variables first of all!
export PEARL_ROOT=$(dirname $(readlink -f "${BASH_ARGV[0]}"))
if [ ! -d $PEARL_ROOT ]; then
    echo "Error: Could not set PEARL_ROOT env because $PEARL_ROOT does not exist."
    return 1
fi
export PEARL_HOME=~/.config/pearl
export PEARL_TEMPORARY=$PEARL_HOME/tmp/`tty`
mkdir -p $PEARL_TEMPORARY
# Variable for logging system
export PEARL_DEBUG=0


# Import the functions from the modules in lib/
source $PEARL_ROOT/lib/utils.sh
source $PEARL_ROOT/lib/core/make.sh
source $PEARL_ROOT/lib/core/makemods.sh

# Set the modules
for category in $(ls ${PEARL_ROOT}/lib/core/mods/)
do
    for mod in $(ls ${PEARL_ROOT}/lib/core/mods/${category})
    do
        if [ "$(ls -A "${PEARL_ROOT}/mods/${category}/${mod}")" ]; then
            if [ -e $PEARL_ROOT/lib/core/mods/${category}/${mod}/config.sh ]; then
                source $PEARL_ROOT/lib/core/mods/${category}/${mod}/config.sh
            fi
        fi
    done
done

# Install pearl if it is not installed yet
pearl_init
